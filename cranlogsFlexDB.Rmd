---
title: "cranLogs"
author: "myTinyShinys"
output: 
  flexdashboard::flex_dashboard:
    css: styles.css
    theme: united
    orientation: rows
    social: [ menu ]
    # source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(plotly)
library(readr)
library(DT)
library(shiny)

library(feather)
library(dplyr)

# Import data
df <- read_feather("data/allCranLogs.feather")
pkgs <- read_csv("data/packages.csv")
#newpkgs <- read_csv("data/newPackages.csv")

# for use in selectInputs
packageChoice <- pkgs$name



```


Individual Packages
===================================== 

Inputs {.sidebar data-width=250}
-------------------------------------

``` {r}
# some background
includeMarkdown("info.md")
hr()
# interactive
selectInput(
"packages_Ind",
"Select (default dplyr)",
choices = packageChoice,
selected = "dplyr",
multiple = FALSE,
selectize = FALSE,
size = 10
)

```

``` {r data carpentry individual}

# saves repeating calculations
indData <- reactive({
data <-   df %>%
filter(package == input$packages_Ind & count > 0) %>%
arrange(rank)

downloads <- data %>%
summarize(tot = sum(count))

info = list(data = data, downloads = downloads)
return(info)
  
})

```

Row
-----------------------------------------------------------------------

### Package 

```{r}

renderValueBox({
  val <-
  paste0(input$packages_Ind, " - ", pkgs[pkgs$name == input$packages_Ind, ]$description)
  
  valueBox(value = val,
  icon = "fa-book")
  
  })



```


Row
-----------------------------------------------------------------------

### Daily Downloads 

```{r}


renderPlotly({
  indData()$data %>%
  plot_ly(
  x = date,
  y = count,
  mode = "markers",
  marker = list(color = "#007bff", size = 3),
  hoverinfo = "text",
  text = paste0(date, "<br> Count: ", count, "<br> Rank: ", rank)
  )  %>%
  
  layout(
  hovermode = "closest",
  xaxis = list(title = ""),
  yaxis = list(title = " ")
  )
  })


```


### Rank

```{r}

renderPlotly({
  indData()$data %>%
  plot_ly(
  x = date,
  y = rank,
  mode = "markers",
  marker = list(color = "#ff9000", size = 3),
  hoverinfo = "text",
  text = paste0(date, "<br> Rank: ", rank, "<br> Count: ", count)
  )  %>%
  layout(xaxis = list(title = ""),
  yaxis = list(autorange = "reversed", title = ""))
  })
  


```



Row
-----------------------------------------------------------------------

### Total Downloads

```{r}

renderValueBox({
  valueBox(value = format(indData()$downloads$tot, big.mark = ","),
  icon = "fa-download")
  
  })



```

### Highest Rank

```{r}

renderValueBox({
  valueBox(value = format(indData()$data$rank[1], big.mark = ","),
  icon = "fa-thumbs-up")
  
  })



```

Multiple Packages
===================================== 

Inputs {.sidebar data-width=250}
-------------------------------------

``` {r}
includeMarkdown("info.md")
hr()
selectInput("packages_Mult","Select or Start Typing ",choices=packageChoice,selected=c("rbokeh","ggvis","plotly","iplots","rggobi","googlevis"), multiple=TRUE)

```

Column {data-width=650}
-----------------------------------------------------------------------

### Daily Downloads - Zoom as required and Hover for details

```{r}


renderPlotly({
  df %>%
  filter(package %in% input$packages_Mult) %>%
  plot_ly(
  x = date,
  y = count,
  mode = "markers",
  color = package
  )  %>%
  layout(xaxis = list(title = ""),
  yaxis = list(title = ""))
  })


```

New Packages
===================================== 

Inputs {.sidebar data-width=250}
-------------------------------------

``` {r}
includeMarkdown("new.md")
hr()
sliderInput("new","Select time scale in days",min=1,max=365,value=7)
actionButton("go_new","Get Table")

```

Column {data-width=650}
-----------------------------------------------------------------------

### Click on Package for CRAN entry {-}

```{r}

output$newTable <- DT::renderDataTable({
  req(input$go_new)
  
  newOnes <-  df %>%
  group_by(package) %>%
  summarize(launched = min(date, na.rm = T)) %>%
  arrange(desc(launched)) %>%
  filter(launched > Sys.Date() - input$new)  #33 good size # up to 166 if 30 days
  #
  newOnes %>%
  left_join(df) %>%
  group_by(package) %>%
  summarize(avDowns = round(sum(count) / n(), 0),
  minRank = min(rank, na.rm = TRUE)) %>%
  inner_join(newOnes) %>%
  left_join(pkgs, by = c("package" = "name")) %>%
  arrange(desc(avDowns)) %>%
  mutate(webUrl = paste0(
  'https://cran.r-project.org/web/packages/',
  package,
  '/index.html'
  )) %>%
  mutate(link = paste0("<a href=\"", webUrl, "\" target=\"_blank\">", package, "</a>")) %>%
  select(
  Package = link,
  Av_per_Day = avDowns,
  Top_rank = minRank,
  Released = launched,
  Description = description
  ) %>%
  DT::datatable(
  class = 'compact stripe hover row-border order-column',
  rownames = TRUE,
  escape = FALSE,
  options = list(
  paging = FALSE,
  searching = TRUE,
  info = FALSE
  )
  )
  
})

dataTableOutput("newTable")

```



